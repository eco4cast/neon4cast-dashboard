---
title: "Terrestrial"
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

```{r setup}
library(ggiraph)
library(patchwork)
library(tidyverse)
library(neon4cast)
library(score4cast)
library(thematic)
library(glue)
#library(bslib)
#bslib::theme_bootswatch("lux")
thematic_rmd(bg="white", fg="black", accent="blue")

source("R/plot-utils.R")

```

```{r}
dashboard <- yaml::read_yaml("dashboard.yml")
```

# Daily averages

```{r }
#combined <- combined_scores("terrestrial_daily") |> filter(time > dashboard$reference_datetime)

theme <- "terrestrial_daily"
combined <- arrow::open_dataset("cache/parquet/terrestrial_daily") |>
  filter(datetime >= lubridate::as_datetime(dashboard$reference_datetime))  |>
  collect() |> score4cast::include_horizon()
```

## Most recent forecasts

Below is the latest forecasts for which we have at least 15 observations. Mouse over to see the team id, scroll to zoom.

```{r}
day <- combined |>
  filter(!is.na(observation)) |>
  count(variable, model_id, reference_datetime, site_id) |>
  filter(n > 15) |> 
  # at least 15 data points
  filter(reference_datetime == max(reference_datetime)) |> # must happen second
  select(reference_datetime) |> distinct(reference_datetime) |> first()
```

## Leaderboard (daily averages)

::: panel-tabset
## Latent evaporation

```{r}
combined |> filter(reference_datetime == day, variable == "le") |> forecast_plots()
```

## CO2 Flux

Net ecosystem exchange of CO2 (NEE)

```{r}
combined |> filter(reference_datetime == day, variable == "nee") |> forecast_plots()
```

## vswc

No data

```{r}
combined |> filter(variable == "vswc", !is.na(observation))
```
:::

```{r}
filled_scores <- fill_scores(combined, null_model = "persistence")
```

```{r}
leaderboard <-  filled_scores |> 
  group_by(variable, model_id) |>
  summarise(crps = mean(crps),
            logs = mean(logs),
            percent_na = mean(is.na(crps_model)),
            .groups = "drop")
```

```{r}
by_start <-  filled_scores |> 
  group_by(variable, model_id, reference_datetime, site_id) |>
  summarise(crps = mean(crps),
            logs = mean(logs),
            percent_na = mean(is.na(crps_model)),
            .groups = "drop")

```

::: panel-tabset
## Latent evaporation

```{r}
leaderboard_plots(leaderboard, NULL, "le")
```

## CO2 flux

```{r}
leaderboard_plots(leaderboard, NULL, "nee")
```

## vswc

(no data)
:::

Overall team rankings by forecast skill. Lower values indicate better predictions. Both score probabilistic forecasts, but log skill penalizes observations outside expected range much more heavily. **Tip**: *Mouse over a color to highlight the scores of one a team*

------------------------------------------------------------------------

# 30 Minute averages

```{r }

#combined <- combined_scores("terrestrial_30min") |>  filter(time > dashboard$reference_datetime)

theme <- "terrestrial_30min"
combined <- arrow::open_dataset(glue("cache/parquet/{theme}")) |>
  filter(datetime >= lubridate::as_datetime(dashboard$reference_datetime)) |>
  collect()|> 
  score4cast::include_horizon() |>
  mutate(reference_datetime = as.Date(reference_datetime))

```

## Most recent forecasts

Below is the latest forecasts for which we have at least 15 observations. Mouse over to see the team id, scroll to zoom.

```{r}
day <- combined |>
  filter(!is.na(observation)) |>
  count(variable, model_id, reference_datetime, site_id) |>
  filter(n > 100) |> 
  # at least 15 data points
  filter(reference_datetime == max(reference_datetime)) |> # must happen second
  select(reference_datetime) |> distinct(reference_datetime) |> first()

end <- as.Date(day) + 4
```

::: panel-tabset
## Latent evaporation

```{r}
combined |> 
  filter(reference_datetime == day, 
         variable == "le",
         datetime < end) |>
  forecast_plots(ncol=3)
```

## CO2 Flux

Net ecosystem exchange of CO2 (NEE)

```{r}
combined |> 
  filter(reference_datetime == day, 
         variable == "nee",
         datetime < end) |> 
  forecast_plots()
```

## vswc

No data

```{r}
combined |> filter(variable == "vswc", !is.na(observation))
```
:::

```{r}
## Fill scores relative to the "climatology" null


filled_scores <- fill_scores(combined, null_model = "climatology")
```

```{r}
leaderboard <-  filled_scores |> 
  group_by(variable, model_id) |>
  summarise(crps = mean(crps),
            logs = mean(logs),
            percent_na = mean(is.na(crps_model)),
            .groups = "drop")
```

```{r}
by_start <-  filled_scores |> 
  group_by(variable, model_id, reference_datetime, site_id) |>
  summarise(crps = mean(crps),
            logs = mean(logs),
            percent_na = mean(is.na(crps_model)),
            .groups = "drop")

```

::: panel-tabset
## Latent evaporation

```{r}
leaderboard_plots(leaderboard, NULL, "le")
```

## CO2 flux

```{r}
leaderboard_plots(leaderboard, NULL, "nee")
```

## vswc

(no data)
:::

Overall team rankings by forecast skill. Lower values indicate better predictions. Both score probabilistic forecasts, but log skill penalizes observations outside expected range much more heavily. **Tip**: *Mouse over a color to highlight the scores of one team*
